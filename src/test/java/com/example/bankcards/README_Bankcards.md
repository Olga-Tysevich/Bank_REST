# Тесты

В этом разделе собраны тесты для приложения **BankCards**. Тесты включают юнит- и интеграционные тесты бизнес-логики с использованием моков, встроенного Spring-контекста и **Testcontainers**. Тестируются ключевые компоненты, такие как авторизация, переводы между картами и другие сервисы.

## Описание

Тесты охватывают основные аспекты работы приложения, включая проверку бизнес-логики, корректность работы сервисов и интеграцию с базой данных. Для реализации тестов используются **JUnit 5**, **Spring Boot Test**, **Testcontainers**, а также другие вспомогательные библиотеки.

### Структура тестов

Все тесты, которые взаимодействуют с инфраструктурой (БД, Redis и т.д.), наследуются от базового класса `BaseTest`. Этот класс отвечает за настройку необходимых контейнеров и конфигурации для корректной работы тестов.

#### Особенности базового класса `BaseTest`:
- Инициализирует контейнеры для **PostgreSQL** и **Redis**.
- Настраивает переменные окружения (в том числе для Liquibase).
- Проверяет доступность Redis через клиент **Lettuce**.
- Настроена и сбрасывается аутентификация пользователя через **SecurityContextHolder**.

Примеры тестов, включенных в проект:

### 1. `AuthServiceImplTest`
- **Успешный вход** по email и паролю.
- **Ошибка при неверном пароле**.

### 2. `TransferServiceImplTransferOnlyBetweenYourCardsTrueTest`
- Переводы разрешены только между картами одного пользователя.
- Проверяется:
  - Перевод между картами одного пользователя.
  - Ошибка при переводе на чужую карту.
  - Ошибки при недостаточном балансе, блокировке карты и прочее.

### 3. `TransferServiceImplTransferOnlyBetweenYourCardsFalseTest`
- Разрешены переводы между картами разных пользователей.
- Проверяется успешный перевод и обновление баланса.

## Используемые технологии

- **JUnit 5** — для написания и выполнения тестов.
- **Spring Boot Test** — для интеграционного тестирования с поднятием Spring-контекста.
- **AssertJ** — для удобных и выразительных проверок в тестах.
- **Testcontainers** — для изоляции тестов с контейнерами PostgreSQL и Redis.
- **Lettuce** — клиент Redis для проверки доступности.
- **@DynamicPropertySource** и **@TestPropertySource** — для управления конфигурациями в тестах.
- **.env.test** — для загрузки тестовых переменных окружения.

## Пример запуска тестов

### Maven
Для запуска тестов с использованием Maven выполните следующую команду в корне проекта:

```bash
mvn test
````

### Структура тестов

В директории `src/test/java/com/example/bankcards/utils/` содержатся вспомогательные классы и константы для тестов:

* **`ObjectBuilder.java`** — класс для создания объектов с заранее определёнными значениями для тестов.
* **`PostgresSQL.java`** — класс для настройки контейнера PostgreSQL с использованием **Testcontainers**.
* **`TestConstants.java`** — класс, содержащий основные константы для тестов (например, тестовые данные).
* **`TestUtils.java`** — вспомогательные утилиты для работы с тестами.

Пример структуры файлов:

```
src/test/java/com/example/bankcards/utils/
  ├── ObjectBuilder.java
  ├── PostgresSQL.java
  ├── TestConstants.java
  └── TestUtils.java
```

## Тесты контроллеров (UI/Integration)

Тесты контроллеров проверяют работу REST API приложения **BankCards**. Эти тесты включают проверку авторизации, HTTP-статусов, корректности схемы JSON-ответов, а также времени отклика.

### Структура тестов контроллеров

* **BaseTest** — базовый класс для всех UI/интеграционных тестов.
* **BaseUITest** — наследуется от `BaseTest` и добавляет методы для выполнения HTTP-запросов (POST, GET, DELETE).
* **AuthControllerTest** — тестирует функциональность авторизации: успешный вход, ошибки при неверных данных и блокировка доступа.

## Как запускать тесты

Для запуска тестов убедитесь, что у вас установлены **Docker** и **JDK 17+**. Затем выполните команду для запуска тестов:

```bash
mvn test
```

или для Gradle:

```bash
gradle test
```

---

## Заключение

Тесты в этом проекте направлены на обеспечение надежности и корректности работы бизнес-логики и взаимодействия с инфраструктурой. Использование **Testcontainers** позволяет изолировать тесты и обеспечивать их воспроизводимость, что важно для тестирования в разных средах.

```
